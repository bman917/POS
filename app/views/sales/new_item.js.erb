$('tbody').append("<%=j render 'sales/item_input_row'%>");
//ATTENTION: this need to happen AFTER the item_input_row has been rendered
disable_add_item_button();

var qty_css = '#qty';
var item_id_css = '#new #item_id';
var item_name_css = '#item_name';
var item_price_css = '#item_price';
var input_css = 'tr#new input';

var ready_to_save_check = function(event) {
  esc_key = 27;
  if (event.keyCode != esc_key) {
    setTimeout(function() {
      if(validate_item_autocomplete(item_id_css, qty_css, item_price_css)) {
        $(input_css).addClass('ready_to_save');  
      } else {
        $(input_css).removeClass('ready_to_save');  
      }
    },100);
  }
}

//Highlight the row when the focus is on item qty field
//=====================================================
$(input_css).on('change' , ready_to_save_check);
$(input_css).on('keydown', ready_to_save_check);
//=====================================================


$('#item_name').autocomplete({
  minLength: 2,
  source: "<%=json_items_path%>",
  change: function( event, ui) {
    $('#add_item_button').addClass('hide');
  },
  select: function( event, ui ) {
    console.log("autocomplete selected item:" + JSON.stringify(ui.item));
    $(item_id_css).val(ui.item.id);
    $(item_price_css).val(ui.item.price);
    console.log("item_id value:" + $(item_id_css).val());
    //$('#item_name').val(ui.item.value);
    $(qty_css).val("");

    //Delay the focus a little bit so the it happens
    //after normal focusing occurs.
    setTimeout(function() {
      $(qty_css).focus(); 
      $('#add_item_button').removeClass('hide');
    }, 100);
    return false;
  }
});

$('#item_name').focus();